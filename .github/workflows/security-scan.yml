# Scan container images for vulnerabilities (Trivy).
# Runs weekly and on manual trigger; reports HIGH/CRITICAL.
name: Security Scan (Trivy)

on:
  schedule:
    # Weekly on Monday 06:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch: {}

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  trivy-scan:
    runs-on: ["gha-runner-scale-set-bandit"]
    permissions:
      contents: read
      security-events: write
      packages: read
    strategy:
      fail-fast: false
      matrix:
        image: [bandit-service, bandit-pipeline]
    steps:
      - name: Run Trivy vulnerability scanner (table)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:latest
          format: table
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: "0"
        env:
          TRIVY_USERNAME: ${{ github.actor }}
          TRIVY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy (SARIF for Security tab)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:latest
          format: sarif
          output: trivy-${{ matrix.image }}.sarif
          severity: CRITICAL,HIGH
          exit-code: "0"
        env:
          TRIVY_USERNAME: ${{ github.actor }}
          TRIVY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Trivy SARIF
        if: success()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.image }}.sarif
          category: trivy-${{ matrix.image }}
